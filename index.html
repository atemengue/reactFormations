<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="style.css" />
    <title>Document</title>
  </head>
  <body>
    <div class="network-fake">
      <label><input type="checkbox" /> Fake network delay</label>
    </div>
    <div class="story"></div>
    <svg class="spinner" viewBox="0 0 100 100" width="20" height="20">
      <circle cx="50" cy="50" r="42" transform="rotate(-90,50,50)" />
    </svg>
    <script src="utils.js"></script>
    <script>
      const jsonplaceholder = "https://jsonplaceholder.typicode.com/posts";

      // get("story.json").then(
      //   function(response) {
      //     console.log(response);
      //   },
      //   function(error) {
      //     console.log(error);
      //   }
      // );

      // get("story.json")
      //   .then(function(response) {
      //     return JSON.parse(response);
      //   })
      //   .then(function(response) {
      //     console.log("YEY JSON!", response);
      //   });

      async function getJSON(url) {
        return await get(url).then(JSON.parse);
      }

      // getJSON(jsonplaceholder).then(function(posts) {
      //   getJSON(`${jsonplaceholder}/${posts[0].id}`).then(function(data) {
      //     console.log(data);
      //   });
      // });

      var postPromise;

      function getPost(i) {
        postPromise = postPromise || getJSON(jsonplaceholder);

        return postPromise.then(function(posts) {
          return getJSON(`${jsonplaceholder}/${posts[i].id}`);
        });
      }

      // getPost(0)
      //   .then(function(post) {
      //     console.log(post);
      //     return getPost(1);
      //   })
      //   .then(function(post) {
      //     console.log(post);
      //   });

      // getJSON(jsonplaceholder)
      //   .then(function(posts) {
      //     console.log(typeof posts);
      //     // return getJSON(`${jsonplaceholder}/${posts[0]}`);
      //   })
      //   .then(function(post1) {
      //     console.log(post1);
      //   });

      // getJSON("story.json").then(function(data) {
      //   console.log(data);
      // });

      // getJSON("story.json")
      //   .then(function(story) {
      //     return getJSON(story.chapterUrls[0]);
      //   })
      //   .then(function(chapter1) {
      //     console.log(chapter1);
      //   });
      // var sequence = Promise.resolve();

      // getJSON(jsonplaceholder)
      //   .then(function(posts) {
      //     posts.forEach(post => {
      //       sequence = sequence.then(function() {
      //         return getJSON(`${jsonplaceholder}/${post.id}`).then(function(
      //           data
      //         ) {
      //           addHtmlToPage(post.id);
      //         });
      //       });
      //     });
      //   })
      //   .then(function() {
      //     addTextToPage("All done");
      //   })
      //   .catch(function() {
      //     addTextToPage("Failed to show chapter");
      //   })
      //   .then(function() {
      //     document.querySelector(".spinner").style.display = "none";
      //   });

      // getJSON(jsonplaceholder)
      //   .then(function(posts) {
      //     posts.reduce(function(sequence, post) {
      //       return sequence.then(function() {
      //         return getJSON(`${jsonplaceholder}/${post.id}`).then(function(
      //           post
      //         ) {
      //           addHtmlToPage(post.id);
      //         });
      //       });
      //     }, Promise.resolve());
      //   })

      //   .catch(_ => {
      //     addTextToPage("Failed to show chapter");
      //   })
      //   .then(function() {
      //     addHtmlToPage("All done!!!");
      //     document.querySelector(".spinner").style.display = "none";
      //   });

      // getJSON(jsonplaceholder)
      //   .then(function(posts) {
      //     // telechargement parallele
      //     return posts
      //       .map(post => getJSON(`${jsonplaceholder}/${post.id}`))
      //       .reduce(function(sequence, postPromise) {
      //         // Utilisez réduire pour enchaîner les promesses ensemble,
      //         // ajouter du contenu à la page pour chaque chapitre
      //         return (
      //           sequence
      //             // Wait for everything in the sequence so far,
      //             // then wait for this chapter to arrive.
      //             .then(function() {
      //               return postPromise;
      //             })
      //             .then(function(post) {
      //               addHtmlToPage(post.body);
      //             })
      //         );
      //       });
      //   }, Promise.resolve())

      //   .catch(_ => {
      //     addTextToPage("Failed to show chapter");
      //   })
      //   .then(function() {
      //     addHtmlToPage("All done!!!");
      //     document.querySelector(".spinner").style.display = "none";
      //   });

      getJSON(jsonplaceholder)
        .then(function(posts) {
          return Promise.all(
            posts.map(post => getJSON(`${jsonplaceholder}/${post.id}`))
          ).then(function(posts) {
            posts.forEach(post => {
              console.log(post);
              addHtmlToPage(post.id);
            });
          });

          then(function(posts) {
            addHtmlToPage("All done!!!");
          });
        })
        .catch(_ => {
          addTextToPage("Failed to show chapter");
        })
        .then(function() {
          addHtmlToPage("All done!!!");
          document.querySelector(".spinner").style.display = "none";
        });
      // try {
      //   var posts = getJSON(jsonplaceholder);
      //   posts.then(function(data) {
      //     console.log(data, "data");
      //   });
      //   console.log(posts);
      //   var post1 = getJSON(`${jsonplaceholder}/1`);
      //   addHtmlToPage(post1.body);
      // } catch (error) {
      //   console.log(error);
      //   addTextToPage("Failed to show chapter");
      // } finally {
      //   document.querySelector(".spinner").style.display = "none";
      // }
    </script>
  </body>
</html>
